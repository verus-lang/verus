# Qi Graph Analysis

This tool parses the serialized `.graph` data produced by the `internals_interface` crate.
The `.graph` file can be generated with `--capture-profiles`, which will place the `.graph` file in the `.verus-solver-log/` directory where you ran verus.


## Usage
```bash
cargo run .\file.graph
```
This will produce 3 files:
- `file.dot` - contains the dot file to visualize the module merged graph, i.e. collapsing sibling nodes that came from the same module.
- `file.quant.dot` - contains the dot file to visualize the quantifier merged graph, a slightly finer granularity for more details.
- `file.json` - Contains a summary of the metrics generated for the previous 2 files:

```json
[
  {
    "module": "betree::FilteredBetreeRefinement_v",
    "functions": [
      {
        "bucket_name": "betree__FilteredBetreeRefinement_v",
        "module": "betree::FilteredBetreeRefinement_v",
        "function": null,
        "file_path": "betree__FilteredBetreeRefinement_v",
        "total_instantiation_count": 32938,   //raw inst count as reported from Z3
        "total_instantiation_count_old": 15225, //inst count after filtering and merging
        "module_blames": [
          {
            "module": "betree::BufferSeq_v",
            "count": 9510, // count for insts that are below a BufferSeq_v node in the graph
            "fraction": 0.288724269840306 // the proportion of the graph that is under BufferSeq_v
          },
          ...
        ],
        "raw_counts_by_module": [
          {
            "module": "spec::KeyType_t",
            "count": 3561, // raw instantiation count for the module
            "fraction": 0.2793379353624098 // the proportion of total instantiations
          },
          ...
        ],
        // same info on quantifier granularity
        "quantifier_blames": [
          {
            "quantifier": "internal_req__bundle!betree.BufferSeq_v.impl&__0.filter_commutes_with_i._definition",
            "count": 7157,
            "fraction": 0.21728702410589593
          },
          ...
        ],
        "raw_counts_by_quantifier": [
          {
            "quantifier": "spec::KeyType_t",
            "count": 3561,
            "fraction": 0.2793379353624098
          },
          ...
        ],
      }
  }
]
        


```

The dot files can be visualized with an installation of `GraphViz`.

Other command line options to run on a directory of graph files can be viewed with 
```bash
cargo run -- -h
```

To generate timing info, pass the json file generated by `--time-expanded --output-json` as the argument to the `-t` argument.

### Visualization

`index.html` can used to visualize the module breakdown information from the above json file. Opening it and loading the `json` can be used to view the information in a more human readable format.